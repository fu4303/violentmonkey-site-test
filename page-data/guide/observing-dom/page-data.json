{"componentChunkName":"component---src-templates-post-template-js","path":"/guide/observing-dom/","result":{"data":{"site":{"siteMetadata":{"title":"Violentmonkey"}},"markdownRemark":{"id":"8167b183-3432-599c-ac2b-a6aa9465bc5c","html":"<h2 id=\"background\" style=\"position:relative;\"><a href=\"#background\" aria-label=\"background permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Background</h2>\n<p>It is a common case to operate on elements that are created dynamically, which may not be ready even on <code class=\"language-text\">document-end</code>.</p>\n<p>In earlier userscripts we can see authors using timers to detect DOM elements periodically, which works in most browsers but is less effective, and there is likely obvious lag after the elements appear and before the operations are performed.</p>\n<p>A better way to do stuff when certain element is ready is to use <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MutationObserver</a> instead of timers. <code class=\"language-text\">MutationObserver</code> is well supported in modern browsers, including those Violentmonkey works on, as defined <a href=\"https://github.com/violentmonkey/violentmonkey/blob/master/.browserslistrc\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>.</p>\n<p>You can stop reading this now if you are familiar with <code class=\"language-text\">MutationObserver</code> and prefer native APIs.</p>\n<h2 id=\"introducing-violentmonkeydom\" style=\"position:relative;\"><a href=\"#introducing-violentmonkeydom\" aria-label=\"introducing violentmonkeydom permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introducing @violentmonkey/dom</h2>\n<p>If you are looking for an easy and friendly way to observe elements, <a href=\"https://github.com/violentmonkey/vm-dom\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">@violentmonkey/dom</a> might be what you want.</p>\n<p><a href=\"https://github.com/violentmonkey/vm-dom\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">@violentmonkey/dom</a> is a library provided by the Violentmonkey team. Nevertheless, it is just pure JavaScript and can be used with other script managers.</p>\n<p>Once the library is required, we can use its methods under the <code class=\"language-text\">VM</code> namespace. See <a href=\"https://violentmonkey.github.io/vm-dom/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the documentation</a> for more details.</p>\n<h3 id=\"requirements\" style=\"position:relative;\"><a href=\"#requirements\" aria-label=\"requirements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Requirements</h3>\n<p>Add <code class=\"language-text\">@violentmonkey/dom</code> to the <a href=\"/api/metadata-block/\">meta block</a> of your script:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// ==UserScript==</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// @require https://cdn.jsdelivr.net/npm/@violentmonkey/dom@1</span></span><span class=\"token comment\">// ==/UserScript==</span></code></pre></div>\n<p>If the project is generated from <a href=\"https://github.com/violentmonkey/generator-userscript\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">our generator</a>, it probably already has this included.</p>\n<h3 id=\"observing\" style=\"position:relative;\"><a href=\"#observing\" aria-label=\"observing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Observing</h3>\n<p>After preparing the requirements, we can observe elements by <code class=\"language-text\">VM.observe</code> (<a href=\"https://violentmonkey.github.io/vm-dom/modules.html#observe\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">doc</a>), which utilizes <code class=\"language-text\">MutationObserver</code> under the hood.</p>\n<p>For example, prepend <code class=\"language-text\">&lt;h1>Profile&lt;/h1></code> to the dynamically created <code class=\"language-text\">&lt;div class=\"profile\"></code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token constant\">VM</span><span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Find the target node</span>\n  <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.profile'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> h1 <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'h1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    h1<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token string\">'Profile'</span><span class=\"token punctuation\">;</span>\n    node<span class=\"token punctuation\">.</span><span class=\"token function\">prepend</span><span class=\"token punctuation\">(</span>h1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// disconnect observer</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Note that <code class=\"language-text\">return true</code> in the last is needed to disconnect the observer once we find the target node. Otherwise the detection continues and makes useless callbacks.</p>\n<p>To observe <code class=\"language-text\">document.body</code> we must make sure <code class=\"language-text\">document.body</code> exists. This should not be a problem if <code class=\"language-text\">@run-at</code> is omitted or set to a value other than <code class=\"language-text\">document-start</code>.</p>\n<h3 id=\"using-jquery\" style=\"position:relative;\"><a href=\"#using-jquery\" aria-label=\"using jquery permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using jQuery</h3>\n<p>It is quite simple to integrate jQuery with the observer. Before we begin we have to include jQuery as a dependency:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// ==UserScript==</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token comment\">// @require https://cdn.jsdelivr.net/npm/@violentmonkey/dom@1</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// @require https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js</span></span><span class=\"token comment\">// ==/UserScript==</span></code></pre></div>\n<p>Then we can wrap the node with jQuery and operate it the jQuery way:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token constant\">VM</span><span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Find the target node</span>\n  <span class=\"token keyword\">const</span> $node <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.profile'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>$node<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    $node<span class=\"token punctuation\">.</span><span class=\"token function\">prepend</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;h1>Profile&lt;/h1>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// disconnect observer</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>","fields":{"tagSlugs":null,"type":"pages"},"frontmatter":{"title":"Observing DOM","tags":null,"date":"2021-02-17 23:16:49+0800","sidebar":{"match":"/guide/","order":2}},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#background\">Background</a></p>\n</li>\n<li>\n<p><a href=\"#introducing-violentmonkeydom\">Introducing @violentmonkey/dom</a></p>\n<ul>\n<li><a href=\"#requirements\">Requirements</a></li>\n<li><a href=\"#observing\">Observing</a></li>\n<li><a href=\"#using-jquery\">Using jQuery</a></li>\n</ul>\n</li>\n</ul>"}},"pageContext":{"slug":"/guide/observing-dom/","type":"pages"}},"staticQueryHashes":["1878747374","2344890832","3365866253","3486277714"]}